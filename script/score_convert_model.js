export const subjectGroups = new Map([
  ["G001", ["to", "vl", "hh"]],
  ["G002", ["to", "vl", "sh"]],
  ["G003", ["to", "vl", "nv"]],
  ["G004", ["to", "vl", "nn"]],
  ["G005", ["to", "vl", "ls"]],
  ["G006", ["to", "vl", "dl"]],
  ["G007", ["to", "vl", "gd"]],
  ["G008", ["to", "vl", "th"]],
  ["G009", ["to", "vl", "cn"]],
  ["G010", ["to", "hh", "sh"]],
  ["G011", ["to", "hh", "nv"]],
  ["G012", ["to", "hh", "nn"]],
  ["G013", ["to", "hh", "ls"]],
  ["G014", ["to", "hh", "dl"]],
  ["G015", ["to", "hh", "gd"]],
  ["G016", ["to", "hh", "th"]],
  ["G017", ["to", "hh", "cn"]],
  ["G018", ["to", "sh", "nv"]],
  ["G019", ["to", "sh", "nn"]],
  ["G020", ["to", "sh", "ls"]],
  ["G021", ["to", "sh", "dl"]],
  ["G022", ["to", "sh", "gd"]],
  ["G023", ["to", "sh", "th"]],
  ["G024", ["to", "sh", "cn"]],
  ["G025", ["to", "nv", "nn"]],
  ["G026", ["to", "nv", "ls"]],
  ["G027", ["to", "nv", "dl"]],
  ["G028", ["to", "nv", "gd"]],
  ["G029", ["to", "nv", "th"]],
  ["G030", ["to", "nv", "cn"]],
  ["G031", ["to", "nn", "ls"]],
  ["G032", ["to", "nn", "dl"]],
  ["G033", ["to", "nn", "gd"]],
  ["G034", ["to", "nn", "th"]],
  ["G035", ["to", "nn", "cn"]],
  ["G036", ["to", "ls", "dl"]],
  ["G037", ["to", "ls", "gd"]],
  ["G038", ["to", "ls", "th"]],
  ["G039", ["to", "ls", "cn"]],
  ["G040", ["to", "dl", "gd"]],
  ["G041", ["to", "dl", "th"]],
  ["G042", ["to", "dl", "cn"]],
  ["G043", ["to", "gd", "th"]],
  ["G044", ["to", "gd", "cn"]],
  ["G045", ["to", "th", "cn"]],
  ["G046", ["vl", "hh", "sh"]],
  ["G047", ["vl", "hh", "nv"]],
  ["G048", ["vl", "hh", "nn"]],
  ["G049", ["vl", "hh", "ls"]],
  ["G050", ["vl", "hh", "dl"]],
  ["G051", ["vl", "hh", "gd"]],
  ["G052", ["vl", "hh", "th"]],
  ["G053", ["vl", "hh", "cn"]],
  ["G054", ["vl", "sh", "nv"]],
  ["G055", ["vl", "sh", "nn"]],
  ["G056", ["vl", "sh", "ls"]],
  ["G057", ["vl", "sh", "dl"]],
  ["G058", ["vl", "sh", "gd"]],
  ["G059", ["vl", "sh", "th"]],
  ["G060", ["vl", "sh", "cn"]],
  ["G061", ["vl", "nv", "nn"]],
  ["G062", ["vl", "nv", "ls"]],
  ["G063", ["vl", "nv", "dl"]],
  ["G064", ["vl", "nv", "gd"]],
  ["G065", ["vl", "nv", "th"]],
  ["G066", ["vl", "nv", "cn"]],
  ["G067", ["vl", "nn", "ls"]],
  ["G068", ["vl", "nn", "dl"]],
  ["G069", ["vl", "nn", "gd"]],
  ["G070", ["vl", "nn", "th"]],
  ["G071", ["vl", "nn", "cn"]],
  ["G072", ["vl", "ls", "dl"]],
  ["G073", ["vl", "ls", "gd"]],
  ["G074", ["vl", "ls", "th"]],
  ["G075", ["vl", "ls", "cn"]],
  ["G076", ["vl", "dl", "gd"]],
  ["G077", ["vl", "dl", "th"]],
  ["G078", ["vl", "dl", "cn"]],
  ["G079", ["vl", "gd", "th"]],
  ["G080", ["vl", "gd", "cn"]],
  ["G081", ["vl", "th", "cn"]],
  ["G082", ["hh", "sh", "nv"]],
  ["G083", ["hh", "sh", "nn"]],
  ["G084", ["hh", "sh", "ls"]],
  ["G085", ["hh", "sh", "dl"]],
  ["G086", ["hh", "sh", "gd"]],
  ["G087", ["hh", "sh", "th"]],
  ["G088", ["hh", "sh", "cn"]],
  ["G089", ["hh", "nv", "nn"]],
  ["G090", ["hh", "nv", "ls"]],
  ["G091", ["hh", "nv", "dl"]],
  ["G092", ["hh", "nv", "gd"]],
  ["G093", ["hh", "nv", "th"]],
  ["G094", ["hh", "nv", "cn"]],
  ["G095", ["hh", "nn", "ls"]],
  ["G096", ["hh", "nn", "dl"]],
  ["G097", ["hh", "nn", "gd"]],
  ["G098", ["hh", "nn", "th"]],
  ["G099", ["hh", "nn", "cn"]],
  ["G100", ["hh", "ls", "dl"]],
  ["G101", ["hh", "ls", "gd"]],
  ["G102", ["hh", "ls", "th"]],
  ["G103", ["hh", "ls", "cn"]],
  ["G104", ["hh", "dl", "gd"]],
  ["G105", ["hh", "dl", "th"]],
  ["G106", ["hh", "dl", "cn"]],
  ["G107", ["hh", "gd", "th"]],
  ["G108", ["hh", "gd", "cn"]],
  ["G109", ["hh", "th", "cn"]],
  ["G110", ["sh", "nv", "nn"]],
  ["G111", ["sh", "nv", "ls"]],
  ["G112", ["sh", "nv", "dl"]],
  ["G113", ["sh", "nv", "gd"]],
  ["G114", ["sh", "nv", "th"]],
  ["G115", ["sh", "nv", "cn"]],
  ["G116", ["sh", "nn", "ls"]],
  ["G117", ["sh", "nn", "dl"]],
  ["G118", ["sh", "nn", "gd"]],
  ["G119", ["sh", "nn", "th"]],
  ["G120", ["sh", "nn", "cn"]],
  ["G121", ["sh", "ls", "dl"]],
  ["G122", ["sh", "ls", "gd"]],
  ["G123", ["sh", "ls", "th"]],
  ["G124", ["sh", "ls", "cn"]],
  ["G125", ["sh", "dl", "gd"]],
  ["G126", ["sh", "dl", "th"]],
  ["G127", ["sh", "dl", "cn"]],
  ["G128", ["sh", "gd", "th"]],
  ["G129", ["sh", "gd", "cn"]],
  ["G130", ["sh", "th", "cn"]],
  ["G131", ["nv", "nn", "ls"]],
  ["G132", ["nv", "nn", "dl"]],
  ["G133", ["nv", "nn", "gd"]],
  ["G134", ["nv", "nn", "th"]],
  ["G135", ["nv", "nn", "cn"]],
  ["G136", ["nv", "ls", "dl"]],
  ["G137", ["nv", "ls", "gd"]],
  ["G138", ["nv", "ls", "th"]],
  ["G139", ["nv", "ls", "cn"]],
  ["G140", ["nv", "dl", "gd"]],
  ["G141", ["nv", "dl", "th"]],
  ["G142", ["nv", "dl", "cn"]],
  ["G143", ["nv", "gd", "th"]],
  ["G144", ["nv", "gd", "cn"]],
  ["G145", ["nv", "th", "cn"]],
  ["G146", ["nn", "ls", "dl"]],
  ["G147", ["nn", "ls", "gd"]],
  ["G148", ["nn", "ls", "th"]],
  ["G149", ["nn", "ls", "cn"]],
  ["G150", ["nn", "dl", "gd"]],
  ["G151", ["nn", "dl", "th"]],
  ["G152", ["nn", "dl", "cn"]],
  ["G153", ["nn", "gd", "th"]],
  ["G154", ["nn", "gd", "cn"]],
  ["G155", ["nn", "th", "cn"]],
  ["G156", ["ls", "dl", "gd"]],
  ["G157", ["ls", "dl", "th"]],
  ["G158", ["ls", "dl", "cn"]],
  ["G159", ["ls", "gd", "th"]],
  ["G160", ["ls", "gd", "cn"]],
  ["G161", ["ls", "th", "cn"]],
  ["G162", ["dl", "gd", "th"]],
  ["G163", ["dl", "gd", "cn"]],
  ["G164", ["dl", "th", "cn"]],
  ["G165", ["gd", "th", "cn"]],
]);

export function round2(value, appreciate) {
  let base = Math.pow(10, appreciate);
  value = Math.round(value * base) / base;

  return value;
}

export function getInRangeVal(value, min, max) {
  value = Math.min(value, max);
  value = Math.max(value, min);
  return value;
}

export function getInterpolate(x1, y1, x2, y2, x) {
  if (x1 === x2) return y2;

  return y1 + ((x - x1) / (x2 - x1)) * (y2 - y1);
}

export function getBinSize(min, max, distSize) {
  return (max - min) / distSize;
}

export function getScore(index, min, max, distSize) {
  return round2(min + index * getBinSize(min, max, distSize), 2);
}

export function getIndex(score, min, max, distSize) {
  return Math.floor((score - min) / getBinSize(min, max, distSize));
}

export function getCumlative(arr) {
  let ans = new Array(arr.length);

  ans[0] = arr[0];

  for (let i = 1; i < arr.length; i++) ans[i] = ans[i - 1] + arr[i];

  return ans;
}

// distData : {dist : [...], min : float, max : float}

export function getPercentile(value, distData) {
  let cumdist = getCumlative(distData.dist);

  for (let i = 0; i < distData.dist.length - 1; i++) {
    let score1 = getScore(i, distData.min, distData.max, distData.dist.length);
    let score2 = getScore(
      i + 1,
      distData.min,
      distData.max,
      distData.dist.length
    );

    if (score1 <= value && value <= score2) {
      let quan1 = i == 0 ? 0 : cumdist[i - 1];
      let quan2 = cumdist[i];

      return (
        getInterpolate(score1, quan1, score2, quan2, value) /
        cumdist[cumdist.length - 1]
      );
    }
  }

  if (value < distData.min) return 0;
  else return 1;
}

export function getScoreAtPercentile(per, distData) {
  if (per < 0) return distData.min;
  else if (per > 1) return distData.max;

  let cumdist = getCumlative(distData.dist);

  for (let i = 0; i < distData.dist.length; i++) {
    let per1 = i == 0 ? 0 : cumdist[i - 1] / cumdist[cumdist.length - 1];
    let per2 = cumdist[i] / cumdist[cumdist.length - 1];

    if (per1 <= per && per <= per2) {
      let score1 = getScore(
        i,
        distData.min,
        distData.max,
        distData.dist.length
      );
      let score2 = getScore(
        i + 1,
        distData.min,
        distData.max,
        distData.dist.length
      );

      return getInterpolate(per1, score1, per2, score2, per);
    }
  }

  return distData.max;
}

export function getConvertedScore(firstScore, firstDistData, secDistData) {
  return getScoreAtPercentile(
    getPercentile(firstScore, firstDistData),
    secDistData
  );
}

export function getAddScore(score, addScoreLevel, base) {
  addScoreLevel = Math.min(addScoreLevel, 0.3 * base);

  if (score < 0.75 * base) return addScoreLevel;
  else return ((base - score) / (0.75 * base)) * addScoreLevel;
}

export function getCompleteScore(score, addScoreLevel, base) {
  return score + getAddScore(score, addScoreLevel, base);
}

export async function getDist(supabase, exam, subject, year, base) {
  let ans = { dist: [0, 1, 6, 0], min: 0, max: base };

  if (subject == "nn") subject = "ans";

  let { data, error } = await supabase
    .from("exam_distribution")
    .select("distribution, min, max")
    .eq("method_id", exam)
    .eq("subject_id", subject)
    .eq("year", year);

  if (!error && data && data.length > 0) {
    ans.dist = data[0].distribution;
    ans.min = data[0].min;
    ans.max = data[0].max;
  }

  return ans;
}

export async function getGroupDist(
  supabase,
  exam,
  subjectGroup,
  year,
  eachBase,
  coefs
) {
  function getScoreArr(distData) {
    let ans = [];

    for (let i = 0; i < distData.dist.length; i++)
      ans.push(getScore(i, distData.min, distData.max, distData.dist.length));

    return ans;
  }

  let dists = await Promise.all(
    subjectGroups
      .get(subjectGroup)
      .map((subject) => getDist(supabase, exam, subject, year, eachBase))
  );

  // for (let subject of subjectGroups.get(subjectGroup))
  //   dists.push(await getDist(supabase, exam, subject, year, eachBase));

  let scoress = [];

  for (let dist of dists) scoress.push(getScoreArr(dist));

  let sumCoef = 0;
  for (let subject of subjectGroups.get(subjectGroup))
    sumCoef += coefs.hasOwnProperty(subject) ? coefs[subject] : 1;

  let ans = {
    dist: new Array(20).fill(0),
    min: 0,
    max: eachBase * sumCoef,
  };

  for (let i = 0; i < Math.min(...scoress.map((arr) => arr.length)); i++) {
    let score = 0;

    // let coef = coefs.hasOwnProperty(subject) ? coefs[subject] : 1;

    for (let j = 0; j < 3; j++) {
      let coef = coefs.hasOwnProperty(subjectGroups.get(subjectGroup)[j])
        ? coefs[subjectGroups.get(subjectGroup)[j]]
        : 1;

      score += scoress[j][i] * coef;
    }

    let index = getInRangeVal(getIndex(score, ans.min, ans.max, 20), 0, 19);
    ans.dist[index]++;
  }

  return ans;
}

////////////////////////////////////////////////////////////////////////////////////////////////////
// SUBJECT GROUP PROCESSING
////////////////////////////////////////////////////////////////////////////////////////////////////

export function isApplySubject(applySubjects, subject) {
  return !applySubjects.has(subject) || applySubjects.get(subject) !== null;
}

export function hasScoreSubject(subject, scores) {
  return !scores.has(subject) || scores.get(subject) !== null;
}

export function isApplyGroup(applySubjects, subjectGroup) {
  for (let subject of subjectGroups.get(subjectGroup))
    if (!isApplySubject(applySubjects, subject)) return false;

  return true;
}

export function hasScoreGroup(subjectGroup, scores) {
  for (let subject of subjectGroups.get(subjectGroup))
    if (!hasScoreSubject(subject, scores)) return false;

  return true;
}

// subjectGroup : string
// index : int
// coefs : {subject : coef, subject : coef, subject : coef ...}

// constraint: scores cant null

export function getGroupScore(subjectGroup, scores, index, coefs) {
  let ans = 0;
  let sumCoefs = 0;

  for (let subject of subjectGroups.get(subjectGroup)) {
    let coef = coefs.hasOwnProperty(subject) ? coefs[subject] : 1;

    sumCoefs += coef;

    if (subject == "nn" && !scores.has("nn")) subject = "an";

    if (index !== null) ans += coef * scores.get(subject)[index];
    else ans += coef * scores.get(subject);
  }

  ans = (ans / sumCoefs) * 3;

  return ans;
}

// applySubjects : map [key : bool]
// scores : map [key : array] / [key : number]
// indexes : array
// coefss : map [key : {subject : coef, subject : coef, subject : coef ...}]

// export function getGroupScores(applySubjects, scores, indexes, coefss) {
//   let ans = new Map([]);

//   for (let subjectGroup of subjectGroups.keys())
//     if (isApplyGroup(applySubjects, subjectGroup)) {
//       let ansScores = [];

//       for (let index of indexes)
//         ansScores.push(
//           getGroupScore(
//             subjectGroup,
//             scores,
//             index,
//             coefss.has(subjectGroup) ? coefss.get(subjectGroup) : {}
//           )
//         );

//       ans.set(subjectGroup, ansScores);
//     }

//   return ans;
// }
